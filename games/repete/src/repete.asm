; RE-PETE
; A Simon clone for ColecoVision.

	include "../../../include/coleco.asm"

	org $8000

	db $aa,$55			; ColecoVision title screen
	dw $0000			; pointer to sprite name table
	dw $0000			; pointer to sprite order table
	dw $0000			; pointer to working buffer for WR_SPR_NM_TBL
	dw CONTROLLER_BUFFER		; pointer to controller input areas
	dw START			; entry point

rst_8:
	reti
	nop
rst_10:
	reti
	nop
rst_18:
	jp RAND_GEN
rst_20:
	reti
	nop
rst_28:
	reti
	nop
rst_30:
	reti
	nop
rst_38:
	reti
	nop

	jp NMI

	db "RE-PETE/ /2023"

START:
	; set stack pointer
	ld SP,StackTop

	; initialize sound
	ld B,SoundDataCount		; max number of active voices+effects
	ld HL,SoundAddrs
	call SOUND_INIT

	; initialize clock
	ld HL,TIMER_TABLE
	ld DE,TIMER_DATA_BLOCK
	call INIT_TIMER

	; set screen mode 2,2 (16x16 sprites)
	call SETSCREEN2

	; enable both joysticks, buttons, keypads
	ld HL,$9b9b
	ld (CONTROLLER_BUFFER),HL

	; seed random numbers
	ld HL,1967
	call SEED_RANDOM

	; enable timers
	call CREATE_TIMERS

MAIN_SCREEN:
	; read joysticks to clear any false reads
	call JOYTST

	; initial seed random with the time that has passed
	LD HL,(TIME)
	call SEED_RANDOM

	; disable interrupts
	call DISABLE_NMI

	; clean up in case the game left anything on screen
	call CLEARSPRITES
	call SPRWRT

	; clear the screen
	call CLEARPAT

	; load the character set
	call LOAD_CHR_SET

	; set up main screen layout
	ld HL,VRAM_NAME
	ld DE,SCREEN_LAYOUT
	ld BC,24*32
	call LDIRVM

MLOOP:
	; check that a base tick has occurred
	; ensures consistent movement speed between 50 & 60 hz systems
	ld A,(TickTimer)
	call TEST_SIGNAL
	or A
	jr Z,MLOOP

	jr MLOOP

LOAD_CHR_SET:
	ld HL,0
SLOOP:
	ld DE,TILESET_PAT
	push HL
	ld BC,TILESET_SIZE*8
	call LDIRVM
	pop HL
	push HL
	ld BC,VRAM_COLOR
	add HL,BC
	; background color
	ld A,$00
	ld BC,2*8
	push BC
	call FILVRM
	pop BC
	add HL,BC
	; text
	ld A,$f0
	ld BC,TILESET_T_SIZE*8
	push BC
	call FILVRM
	pop BC
	add HL,BC
	; green
	ld A,$c0
	ld BC,TILESET_G_SIZE*8
	push BC
	call FILVRM
	pop BC
	add HL,BC
	; yellow
	ld A,$a0
	ld BC,TILESET_Y_SIZE*8
	push BC
	call FILVRM
	pop BC
	add HL,BC
	; red
	ld A,$60
	ld BC,TILESET_R_SIZE*8
	push BC
	call FILVRM
	pop BC
	add HL,BC
	; blue
	ld A,$40
	ld BC,TILESET_B_SIZE*8
	push BC
	call FILVRM
	pop BC
	pop HL
	ld BC,$800
	add HL,BC
	ld A,H
	cp $18
	jr C,SLOOP
	ret

VDU_WRITES:
	ret

TILESET_SIZE:		equ 189
TILESET_T_SIZE:		equ 19
TILESET_G_SIZE:		equ 45
TILESET_Y_SIZE:		equ 39
TILESET_R_SIZE:		equ 39
TILESET_B_SIZE:		equ 45

TILESET_PAT:
	; background tiles
	db 255,255,255,255,255,255,255,255 ; 000
	db 000,000,000,000,000,000,000,000 ; 001
	; logo text tiles
	db 063,127,255,255,248,240,240,240 ; 002
	db 252,254,255,255,031,015,015,015 ; 003
	db 063,127,255,255,248,240,255,255 ; 004
	db 252,254,255,255,031,015,255,255 ; 005
	db 000,000,000,000,000,000,063,063 ; 006
	db 000,000,000,000,000,000,252,252 ; 007
	db 063,127,255,255,240,240,255,255 ; 008
	db 252,254,255,255,015,015,255,255 ; 009
	db 255,255,255,255,003,003,003,003 ; 010
	db 255,255,255,255,192,192,192,192 ; 011
	db 240,240,240,240,240,240,240,240 ; 012
	db 255,255,240,248,255,255,127,063 ; 013
	db 255,255,000,000,255,255,255,255 ; 014
	db 063,063,000,000,000,000,000,000 ; 015
	db 252,252,000,000,000,000,000,000 ; 016
	db 255,255,240,240,240,240,240,240 ; 017
	db 254,252,000,000,000,000,000,000 ; 018
	db 003,003,003,003,003,003,001,000 ; 019
	db 192,192,192,224,255,255,255,255 ; 020
	; green tiles
	db 000,000,000,000,000,003,031,255 ; 021
	db 000,000,000,000,063,255,255,255 ; 022
	db 000,000,015,255,255,255,255,255 ; 023
	db 000,063,255,255,255,255,255,255 ; 024
	db 031,255,255,255,255,255,255,255 ; 025
	db 255,255,255,255,255,255,255,255 ; 026
	db 248,255,255,255,255,255,255,255 ; 027
	db 000,252,255,255,255,255,255,255 ; 028
	db 000,000,240,255,255,255,255,255 ; 029
	db 000,000,000,192,252,255,255,255 ; 030
	db 000,000,000,000,000,192,248,255 ; 031
	db 000,000,000,000,000,000,003,015 ; 032
	db 000,000,001,007,063,255,255,255 ; 033
	db 007,063,255,255,255,255,255,255 ; 034
	db 224,252,255,255,255,255,255,255 ; 035
	db 000,000,128,224,252,255,255,255 ; 036
	db 000,000,000,000,000,000,192,240 ; 037
	db 000,000,003,007,031,127,255,127 ; 038
	db 063,255,255,255,255,255,255,255 ; 039
	db 252,255,255,255,255,255,255,255 ; 040
	db 000,000,192,224,248,254,255,254 ; 041
	db 063,015,007,003,000,000,000,000 ; 042
	db 255,255,255,255,255,127,063,015 ; 043
	db 255,255,255,255,255,254,252,240 ; 044
	db 252,240,224,192,000,000,000,000 ; 045
	db 007,003,000,000,000,000,000,000 ; 046
	db 255,255,255,127,063,015,007,003 ; 047
	db 255,255,255,254,252,240,224,192 ; 048
	db 224,192,000,000,000,000,000,000 ; 049
	db 255,127,063,015,007,001,000,000 ; 050
	db 255,255,255,255,255,255,255,127 ; 051
	db 255,255,255,255,255,255,255,252 ; 052
	db 255,255,255,255,248,192,000,000 ; 053
	db 255,255,240,000,000,000,000,000 ; 054
	db 254,000,000,000,000,000,000,000 ; 055
	db 127,000,000,000,000,000,000,000 ; 056
	db 255,255,015,000,000,000,000,000 ; 057
	db 255,255,255,255,031,003,000,000 ; 058
	db 255,255,255,255,255,255,255,063 ; 059
	db 255,255,255,255,255,255,255,254 ; 060
	db 255,254,252,240,224,128,000,000 ; 061
	db 031,015,007,000,000,000,000,000 ; 062
	db 240,192,000,000,000,000,000,000 ; 063
	db 015,003,000,000,000,000,000,000 ; 064
	db 248,240,224,000,000,000,000,000 ; 065
	; yellow tiles
	db 000,000,000,000,000,003,007,015 ; 066
	db 000,000,000,000,000,192,224,240 ; 067
	db 000,000,000,000,001,003,007,015 ; 068
	db 031,063,127,255,255,255,255,255 ; 069
	db 252,254,255,255,255,255,255,255 ; 070
	db 000,000,000,192,224,240,252,254 ; 071
	db 000,000,000,000,000,001,003,007 ; 072
	db 255,255,255,255,255,255,255,255 ; 073
	db 000,192,224,240,252,254,255,255 ; 074
	db 000,000,000,000,000,000,000,192 ; 075
	db 007,015,031,031,063,063,127,255 ; 076
	db 224,240,252,254,255,255,255,255 ; 077
	db 000,000,000,000,128,192,224,248 ; 078
	db 000,001,001,003,003,003,007,007 ; 079
	db 252,254,252,248,240,224,192,128 ; 080
	db 015,015,015,031,031,031,063,063 ; 081
	db 255,254,254,252,252,248,240,240 ; 082
	db 063,063,127,127,127,127,127,127 ; 083
	db 224,224,224,192,192,192,128,128 ; 084
	db 128,128,000,000,000,000,000,000 ; 085
	db 000,000,000,000,000,000,128,128 ; 086
	db 127,127,127,127,127,127,063,063 ; 087
	db 128,128,192,192,192,224,224,224 ; 088
	db 063,063,031,031,031,015,015,015 ; 089
	db 240,240,248,252,252,254,254,255 ; 090
	db 007,007,003,003,003,001,001,000 ; 091
	db 128,192,224,240,248,252,254,252 ; 092
	db 255,127,063,063,031,031,015,007 ; 093
	db 255,255,255,255,254,252,240,224 ; 094
	db 248,224,192,128,000,000,000,000 ; 095
	db 007,003,001,000,000,000,000,000 ; 096
	db 255,255,255,255,255,127,063,031 ; 097
	db 255,255,254,252,240,224,192,000 ; 098
	db 192,000,000,000,000,000,000,000 ; 099
	db 015,007,003,001,000,000,000,000 ; 100
	db 255,255,255,255,255,255,254,252 ; 101
	db 254,252,240,224,192,000,000,000 ; 102
	db 015,007,003,000,000,000,000,000 ; 103
	db 240,224,192,000,000,000,000,000 ; 104
	; red tiles
	db 000,000,000,000,000,003,007,015 ; 105
	db 000,000,000,000,000,192,224,240 ; 106
	db 000,000,000,003,007,015,063,127 ; 107
	db 063,127,255,255,255,255,255,255 ; 108
	db 248,252,254,255,255,255,255,255 ; 109
	db 000,000,000,000,128,192,224,240 ; 110
	db 000,000,000,000,000,000,000,003 ; 111
	db 000,003,007,015,063,127,255,255 ; 112
	db 255,255,255,255,255,255,255,255 ; 113
	db 000,000,000,000,000,128,192,224 ; 114
	db 000,000,000,000,001,003,007,031 ; 115
	db 007,015,063,127,255,255,255,255 ; 116
	db 224,240,248,248,252,252,254,255 ; 117
	db 063,127,063,031,015,007,003,001 ; 118
	db 000,128,128,192,192,192,224,224 ; 119
	db 255,127,127,063,063,031,015,015 ; 120
	db 240,240,240,248,248,248,252,252 ; 121
	db 007,007,007,003,003,003,001,001 ; 122
	db 252,252,254,254,254,254,254,254 ; 123
	db 001,001,000,000,000,000,000,000 ; 124
	db 000,000,000,000,000,000,001,001 ; 125
	db 001,001,003,003,003,007,007,007 ; 126
	db 254,254,254,254,254,254,252,252 ; 127
	db 015,015,031,063,063,127,127,255 ; 128
	db 252,252,248,248,248,240,240,240 ; 129
	db 001,003,007,015,031,063,127,063 ; 130
	db 224,224,192,192,192,128,128,000 ; 131
	db 031,007,003,001,000,000,000,000 ; 132
	db 255,255,255,255,127,063,015,007 ; 133
	db 255,254,252,252,248,248,240,224 ; 134
	db 003,000,000,000,000,000,000,000 ; 135
	db 255,255,127,063,015,007,003,000 ; 136
	db 255,255,255,255,255,254,252,248 ; 137
	db 224,192,128,000,000,000,000,000 ; 138
	db 127,063,015,007,003,000,000,000 ; 139
	db 255,255,255,255,255,255,127,063 ; 140
	db 240,224,192,128,000,000,000,000 ; 141
	db 015,007,003,000,000,000,000,000 ; 142
	db 240,224,192,000,000,000,000,000 ; 143
	; blue tiles
	db 000,000,000,000,000,007,015,031 ; 144
	db 000,000,000,000,000,000,192,240 ; 145
	db 000,000,000,000,000,000,003,015 ; 146
	db 000,000,000,000,000,224,240,248 ; 147
	db 000,000,001,007,015,063,127,255 ; 148
	db 127,255,255,255,255,255,255,255 ; 149
	db 252,255,255,255,255,255,255,255 ; 150
	db 000,000,192,248,255,255,255,255 ; 151
	db 000,000,000,000,000,240,255,255 ; 152
	db 000,000,000,000,000,000,000,254 ; 153
	db 000,000,000,000,000,000,000,127 ; 154
	db 000,000,000,000,000,015,255,255 ; 155
	db 000,000,003,031,255,255,255,255 ; 156
	db 063,255,255,255,255,255,255,255 ; 157
	db 254,255,255,255,255,255,255,255 ; 158
	db 000,000,128,224,240,252,254,255 ; 159
	db 000,000,000,000,000,000,003,007 ; 160
	db 003,007,015,063,127,255,255,255 ; 161
	db 255,255,255,255,255,255,255,255 ; 162
	db 192,224,240,252,254,255,255,255 ; 163
	db 000,000,000,000,000,000,192,224 ; 164
	db 000,000,000,000,003,007,015,063 ; 165
	db 015,063,127,255,255,255,255,255 ; 166
	db 240,252,254,255,255,255,255,255 ; 167
	db 000,000,000,000,192,224,240,252 ; 168
	db 127,255,127,031,007,003,000,000 ; 169
	db 255,255,255,255,255,255,255,063 ; 170
	db 255,255,255,255,255,255,255,252 ; 171
	db 254,255,254,248,224,192,000,000 ; 172
	db 015,003,000,000,000,000,000,000 ; 173
	db 255,255,255,063,007,001,000,000 ; 174
	db 255,255,255,255,255,255,063,007 ; 175
	db 255,255,255,255,255,255,252,224 ; 176
	db 255,255,255,252,224,128,000,000 ; 177
	db 240,192,000,000,000,000,000,000 ; 178
	db 255,031,003,000,000,000,000,000 ; 179
	db 255,255,255,063,003,000,000,000 ; 180
	db 255,255,255,255,255,015,000,000 ; 181
	db 255,255,255,255,255,255,063,000 ; 182
	db 255,255,255,255,255,255,255,031 ; 183
	db 255,255,255,255,255,255,255,248 ; 184
	db 255,255,255,255,255,255,252,000 ; 185
	db 255,255,255,255,255,240,000,000 ; 186
	db 255,255,255,252,192,000,000,000 ; 187
	db 255,248,192,000,000,000,000,000 ; 188

SCREEN_LAYOUT:
	db 001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001 ; 000
	db 001,001,001,001,001,001,001,001,001,001,021,022,023,024,025,026,026,027,028,029,030,031,001,001,001,001,001,001,001,001,001,001 ; 001
	db 001,001,001,001,001,001,001,032,033,034,026,026,026,026,026,026,026,026,026,026,026,026,035,036,037,001,001,001,001,001,001,001 ; 002
	db 001,001,001,001,001,001,038,039,026,026,026,026,026,026,026,026,026,026,026,026,026,026,026,026,040,041,001,001,001,001,001,001 ; 003
	db 001,001,001,001,066,067,042,043,026,026,026,026,026,026,026,026,026,026,026,026,026,026,026,026,044,045,105,106,001,001,001,001 ; 004
	db 001,001,001,068,069,070,071,046,047,026,026,026,026,026,026,026,026,026,026,026,026,026,026,048,049,107,108,109,110,001,001,001 ; 005
	db 001,001,072,069,073,073,073,074,075,050,051,052,053,054,055,001,001,056,057,058,059,060,061,111,112,113,113,113,109,114,001,001 ; 006
	db 001,001,076,073,073,073,073,073,077,078,062,063,001,001,001,001,001,001,001,001,064,065,115,116,113,113,113,113,113,117,001,001 ; 007
	db 001,079,073,073,073,073,073,073,073,080,001,001,001,001,001,001,001,001,001,001,001,001,118,113,113,113,113,113,113,113,119,001 ; 008
	db 001,081,073,073,073,073,073,073,082,001,001,001,001,001,001,001,001,001,001,001,001,001,001,120,113,113,113,113,113,113,121,001 ; 009
	db 001,083,073,073,073,073,073,073,084,001,001,001,001,001,001,001,001,001,001,001,001,001,001,122,113,113,113,113,113,113,123,001 ; 010
	db 001,073,073,073,073,073,073,073,085,002,003,004,005,006,007,008,009,004,005,010,011,004,005,124,113,113,113,113,113,113,113,001 ; 011
	db 001,073,073,073,073,073,073,073,086,012,001,013,014,015,016,017,018,013,014,019,020,013,014,125,113,113,113,113,113,113,113,001 ; 012
	db 001,087,073,073,073,073,073,073,088,001,001,001,001,001,001,001,001,001,001,001,001,001,001,126,113,113,113,113,113,113,127,001 ; 013
	db 001,089,073,073,073,073,073,073,090,001,001,001,001,001,001,001,001,001,001,001,001,001,001,128,113,113,113,113,113,113,129,001 ; 014
	db 001,091,073,073,073,073,073,073,073,092,001,001,001,001,001,001,001,001,001,001,001,001,130,113,113,113,113,113,113,113,131,001 ; 015
	db 001,001,093,073,073,073,073,073,094,095,144,145,001,001,001,001,001,001,001,001,146,147,132,133,113,113,113,113,113,134,001,001 ; 016
	db 001,001,096,097,073,073,073,098,099,148,149,150,151,152,153,001,001,154,155,156,157,158,159,135,136,113,113,113,137,138,001,001 ; 017
	db 001,001,001,100,097,101,102,160,161,162,162,162,162,162,162,162,162,162,162,162,162,162,162,163,164,139,140,137,141,001,001,001 ; 018
	db 001,001,001,001,103,104,165,166,162,162,162,162,162,162,162,162,162,162,162,162,162,162,162,162,167,168,142,143,001,001,001,001 ; 019
	db 001,001,001,001,001,001,169,170,162,162,162,162,162,162,162,162,162,162,162,162,162,162,162,162,171,172,001,001,001,001,001,001 ; 020
	db 001,001,001,001,001,001,001,173,174,175,162,162,162,162,162,162,162,162,162,162,162,162,176,177,178,001,001,001,001,001,001,001 ; 021
	db 001,001,001,001,001,001,001,001,001,001,179,180,181,182,183,162,162,184,185,186,187,188,001,001,001,001,001,001,001,001,001,001 ; 022
	db 001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001,001 ; 023

bounce:
	db 081h, 054h, 010h, 002h, 023h, 007h
	db $90 ; end
	dw $0000

SoundDataCount:		equ 7
Len_SoundDataArea:	equ 10*SoundDataCount+1 	; 7 data areas
SoundAddrs:
	dw bounce,SoundDataArea				; 1 ball bounce sound
	dw 0,0

	include "../../../include/library.asm"

END:	equ $

	org RAMSTART

BALL:   ds 2

SoundDataArea:
	ds Len_SoundDataArea
